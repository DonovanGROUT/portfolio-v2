# ğŸš€ Pipeline de DÃ©ploiement - Portfolio PlanetHoster
# Ce workflow gÃ¨re le dÃ©ploiement du portfolio vers PlanetHoster
# via SSH sÃ©curisÃ© avec transfert SFTP aprÃ¨s validation complÃ¨te de la qualitÃ©
name: ğŸš€ Deploy to PlanetHoster

# DÃ©clencheurs
on:
  push:
    branches: [main] # DÃ©ploiement automatique sur main
  workflow_dispatch: # DÃ©ploiement manuel possible

# Variables d'environnement
env:
  NODE_VERSION: "18.x"

jobs:
  # ===================================================================
  # PRÃ‰-REQUIS: VÃ©rification de la qualitÃ© avant dÃ©ploiement
  # ===================================================================
  quality-gate:
    name: ğŸš¨ Quality Gate
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # Tests rapides pour vÃ©rifier que tout fonctionne
      - name: âœ… Quick quality check
        run: |
          npm run format:check
          npm run lint:strict
          npm run test:run

      - name: ğŸ—ï¸ Build for production
        run: npm run build

      # Archivage du build optimisÃ© pour dÃ©ploiement
      - name: ğŸ“¦ Archive production build
        uses: actions/upload-artifact@v3
        with:
          name: production-build
          path: |
            .next/
            public/
            package.json
            next.config.ts
          retention-days: 7

  # ===================================================================
  # DÃ‰PLOIEMENT: Upload vers PlanetHoster
  # ===================================================================
  deploy-production:
    name: ğŸŒ Deploy to PlanetHoster
    runs-on: ubuntu-latest
    needs: quality-gate
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: production-build
          path: ./build

      # Configuration pour PlanetHoster
      - name: ğŸ”§ Setup deployment
        run: |
          echo "ğŸš€ Preparing deployment to PlanetHoster..."
          echo "ğŸ“ Build artifacts ready"
          ls -la ./build

      # DÃ©ploiement via SFTP vers PlanetHoster N0c (clÃ© SSH sÃ©curisÃ©e)
      - name: ğŸŒ Deploy via SFTP
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{ secrets.PLANETHOSTER_SSH_PRIVATE_KEY }}
          ARGS: "-rlgoDzvc -i --delete"
          SOURCE: "./build/"
          REMOTE_HOST: ${{ secrets.PLANETHOSTER_HOST }}
          REMOTE_USER: ${{ secrets.PLANETHOSTER_USERNAME }}
          REMOTE_PORT: ${{ secrets.PLANETHOSTER_PORT }}
          TARGET: ${{ secrets.PLANETHOSTER_PATH }}

      # Tests post-dÃ©ploiement
      - name: ğŸ” Verify deployment
        run: |
          echo "ğŸ” Verifying deployment..."
          echo "âš ï¸ Manual verification recommended for first deploy"

      # Notification de succÃ¨s
      - name: ğŸ‰ Deployment successful
        run: |
          echo "âœ… DEPLOYMENT SUCCESSFUL!"
          echo "ğŸŒ Site: https://donovan-grout.com"
          echo "ğŸ“… Deployed: $(date)"
          echo "ğŸ”— Commit: ${{ github.sha }}"

  # ===================================================================
  # NETTOYAGE: Suppression des artÃ©facts temporaires
  # ===================================================================
  cleanup:
    name: ğŸ§¹ Cleanup
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always()

    steps:
      - name: ğŸ—‘ï¸ Clean up artifacts
        run: |
          echo "ğŸ§¹ Cleaning up deployment artifacts..."
          echo "âœ… Cleanup complete"
