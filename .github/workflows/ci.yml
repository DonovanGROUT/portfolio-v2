# ğŸ”§ Pipeline d'IntÃ©gration Continue (CI) - Portfolio
# Ce workflow s'exÃ©cute automatiquement sur chaque push et pull request
# AdaptÃ© pour un portfolio personnel avec dÃ©ploiement sur PlanetHoster
name: ğŸ”§ CI Pipeline

# DÃ©clencheurs du pipeline
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch: # DÃ©clenchement manuel

# Variables d'environnement
env:
  NODE_VERSION: "18.x"

jobs:
  # ===================================================================
  # JOB PRINCIPAL: Tests de QualitÃ© et Build
  # ===================================================================
  quality:
    name: ğŸ§ª Quality & Testing
    runs-on: ubuntu-latest

    steps:
      # RÃ©cupÃ©ration du code source
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Installation Node.js avec cache
      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      # Installation des dÃ©pendances
      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      # VÃ©rification du formatage (Prettier)
      - name: ğŸ¨ Check code formatting
        run: pnpm run format:check

      # Analyse statique (ESLint strict)
      - name: ğŸ” Lint code (strict mode)
        run: pnpm run lint:strict

      # VÃ©rification des types TypeScript
      - name: ğŸ“ Type checking
        run: npx tsc --noEmit

      # Build de production
      - name: ğŸ—ï¸ Build project
        run: pnpm build

      # Tests unitaires
      - name: ğŸ§ª Run unit tests
        run: pnpm run test:run

      # GÃ©nÃ©ration du rapport de couverture
      - name: ğŸ“Š Generate coverage report
        run: pnpm run test:coverage

      # Archivage du build pour dÃ©ploiement
      - name: ğŸ“¦ Archive build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            .next/
            public/
            package.json
          retention-days: 1

  # ===================================================================
  # JOB SÃ‰CURITÃ‰: Audit des vulnÃ©rabilitÃ©s
  # ===================================================================
  security:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      # Audit des vulnÃ©rabilitÃ©s avec audit-ci (config stricte)
      - name: ğŸ›¡ï¸ Security vulnerability scan
        run: pnpm run audit:security

  # ===================================================================
  # JOB PERFORMANCE: Tests Lighthouse
  # ===================================================================
  lighthouse:
    name: ğŸš¦ Performance Tests
    runs-on: ubuntu-latest
    needs: [quality] # Attend que le build soit prÃªt

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ Build for production
        run: pnpm build

      - name: ğŸš€ Start server in background
        run: pnpm start &

      - name: â³ Wait for server to be ready
        run: npx wait-on http://localhost:3000 --timeout 60000

      - name: ğŸš¦ Run Lighthouse Desktop audit
        run: LHCI_GITHUB_TOKEN=${{ secrets.LHCI_GITHUB_TOKEN }} pnpm run lighthouse

      - name: ğŸ“± Run Lighthouse Mobile audit
        run: LHCI_GITHUB_TOKEN=${{ secrets.LHCI_GITHUB_TOKEN }} pnpm run lighthouse:mobile
        continue-on-error: true # N'interrompt pas le pipeline en cas d'Ã©chec

  # ===================================================================
  # JOB RÃ‰SUMÃ‰: Statut global du pipeline
  # ===================================================================
  summary:
    name: ğŸ“‹ Pipeline Summary
    runs-on: ubuntu-latest
    needs: [quality, security, lighthouse]
    if: always() # S'exÃ©cute mÃªme si certains jobs Ã©chouent

    steps:
      - name: ğŸ“Š Display pipeline results
        run: |
          echo "ğŸ¯ CI Pipeline Results:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "âœ¨ Quality & Tests: ${{ needs.quality.result }}"
          echo "ğŸ”’ Security Audit: ${{ needs.security.result }}"
          echo "ğŸš¦ Performance: ${{ needs.lighthouse.result }}"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

          # DÃ©termine le statut global
          if [[ "${{ needs.quality.result }}" == "success" &&
                "${{ needs.security.result }}" == "success" ]]; then
            echo "âœ… Pipeline PASSED - Ready for deployment!"
            echo "ğŸš€ Code quality validated and secure"
            if [[ "${{ needs.lighthouse.result }}" != "success" ]]; then
              echo "âš ï¸  Note: Performance tests had issues (non-blocking)"
            fi
          else
            echo "âŒ Pipeline FAILED - Issues to resolve"
            echo "ğŸ”§ Please check the failed jobs above"
            exit 1
          fi
